<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>GuideRAI — подбор специальностей</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="adminlte/plugins/fontawesome-free/css/all.min.css">
  <!-- AdminLTE -->
  <link rel="stylesheet" href="adminlte/dist/css/adminlte.min.css">
</head>
<style>
.ai-message {
  background: #f4f6f9;
  border-radius: 8px;
  padding: 10px 12px;
  margin-bottom: 10px;
}

.ai-option {
  margin: 5px 5px 0 0;
}
</style>

<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <span class="navbar-brand font-weight-bold">GuideRAI</span>
  </nav>

  <!-- Content -->
  <div class="content-wrapper">
    <section class="content pt-3">
      <div class="container-fluid" id="app">

        <!-- FILTERS -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-search mr-1"></i>
              Подбор специальности
            </h3>
            <button class="btn btn-sm btn-danger float-right" onclick="resetDialog()">
              Начать заново
            </button>
          </div>

          <div class="card-body">
            <div class="row">

              <div class="col-md-3">
                <label>Язык обучения</label>
                <input id="language" class="form-control" placeholder="Русский">
              </div>

              <div class="col-md-3">
                <label>Направление</label>
                <input id="specialty" class="form-control" placeholder="Информатика">
              </div>

              <div class="col-md-4">
                <label>Регион</label>
                <select id="region_id" class="form-control">
                  <option value="">Выберите регион</option>
                </select>
              </div>

              <div class="col-md-4">
                <label>Район</label>
                <select id="district_id" class="form-control" disabled>
                  <option value="">Сначала выберите регион</option>
                </select>
              </div>

              <div class="col-md-4">
                <label>Город / населённый пункт</label>
                <select id="locality_id" class="form-control" disabled>
                  <option value="">Сначала выберите район</option>
                </select>
              </div>

              <div class="col-md-3">
                <label>Тип обучения</label>
                <select id="budget" class="form-control">
                  <option value="">Любой</option>
                  <option value="true">Бюджет</option>
                  <option value="false">Платно</option>
                </select>
              </div>
              <div class="col-md-3">
                <label>Сортировка</label>
                <select id="sort" class="form-control">
                  <option value="">По умолчанию</option>
                  <option value="plan_count">По количеству мест</option>
                  <option value="price">По цене</option>
                  <option value="institution">По названию ВУЗа</option>
                </select>
              </div>

              <div class="col-md-3">
                <label>Порядок</label>
                <select id="order" class="form-control">
                  <option value="desc">По убыванию</option>
                  <option value="asc">По возрастанию</option>
                </select>
              </div>

            </div>

            <div class="mt-3">
              <button class="btn btn-primary" onclick="search()">
                <i class="fas fa-filter mr-1"></i>
                Подобрать
              </button>
            </div>
          </div>
        </div>

        <!-- RESULTS -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-list mr-1"></i>
              Результаты
            </h3>
          </div>

          <div class="card-body p-0">
            <table class="table table-striped mb-0">
              <thead>
                <tr>
                  <th style="width:50px">№</th>
                  <th>ВУЗ</th>
                  <th>Регион</th>
                  <th>Специальность</th>
                  <th>Язык</th>
                  <th>Цена</th>
                  <th>Места</th>
                </tr>
              </thead>
              <tbody id="results">
                <tr>
                  <td colspan="6" class="text-center text-muted">
                    Задайте параметры поиска
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="d-flex justify-content-between align-items-center p-2">
              <button class="btn btn-sm btn-secondary" id="prevPage" disabled>
                ← Назад
              </button>

              <span id="pageInfo" class="text-muted">
                Страница 1
              </span>

              <button class="btn btn-sm btn-secondary" id="nextPage" disabled>
                Вперёд →
              </button>
            </div>
          </div>

        </div>

        <div class="card mt-3" id="ai-dialog-card" style="display:none;">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-robot mr-1"></i>
              Консультант
            </h3>
          </div>

          <div class="card-body">
            <div id="ai-messages" class="mb-3"></div>

            <div id="ai-options" class="d-flex flex-wrap gap-2"></div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <footer class="main-footer text-center">
    GuideRAI © 2026
  </footer>

</div>

<!-- jQuery -->
<script src="adminlte/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE -->
<script src="adminlte/dist/js/adminlte.min.js"></script>
<script>
/* ================= SESSION ================= */
let SESSION_ID = localStorage.getItem('ai_session_id');
if (!SESSION_ID) {
  SESSION_ID = crypto.randomUUID();
  localStorage.setItem('ai_session_id', SESSION_ID);
}
</script>

<script>
/* ================= CONFIG ================= */
const API = 'http://127.0.0.1:8000';
const AI_API = `${API}/ai/dialog`;

/* ================= STATE ================= */
let allResults = [];
let lastResults = [];
let currentPage = 1;
const pageSize = 10;

/* ================= INIT ================= */
$(document).ready(() => {
  loadRegions();
  restoreFilters();
  restoreResults();
  restoreChat();
});

/* ================= META ================= */
async function loadRegions() {
  const res = await fetch(`${API}/meta/regions`);
  const data = await res.json();

  const region = $('#region_id');
  region.html('<option value="">Выберите регион</option>');

  data.forEach(r => {
    region.append(`<option value="${r.id}">${r.name}</option>`);
  });
}

$('#region_id').on('change', async function () {
  const regionId = $(this).val();
  const district = $('#district_id');
  const locality = $('#locality_id');

  district.prop('disabled', true).html('<option>Загрузка...</option>');
  locality.prop('disabled', true).html('<option>Сначала выберите район</option>');

  if (!regionId) return;

  const res = await fetch(`${API}/meta/districts?region_id=${regionId}`);
  const data = await res.json();

  district.html('<option value="">Выберите район</option>');
  data.forEach(d => district.append(`<option value="${d.id}">${d.name}</option>`));
  district.prop('disabled', false);
});

$('#district_id').on('change', async function () {
  const districtId = $(this).val();
  const locality = $('#locality_id');

  locality.prop('disabled', true).html('<option>Загрузка...</option>');
  if (!districtId) return;

  const res = await fetch(`${API}/meta/localities?district_id=${districtId}`);
  const data = await res.json();

  locality.html('<option value="">Выберите населённый пункт</option>');
  data.forEach(l => locality.append(`<option value="${l.id}">${l.name}</option>`));
  locality.prop('disabled', false);
});

/* ================= SEARCH ================= */
async function search() {
  const params = new URLSearchParams();

  const f = {
    language: $('#language').val().trim(),
    specialty: $('#specialty').val().trim(),
    region_id: $('#region_id').val(),
    district_id: $('#district_id').val(),
    locality_id: $('#locality_id').val(),
    budget: $('#budget').val()
  };

  Object.entries(f).forEach(([k, v]) => v && params.append(k, v));
  saveFilters();

  $('#results').html(`<tr><td colspan="7" class="text-center">Поиск...</td></tr>`);

  const res = await fetch(`${API}/search/?${params.toString()}`);
  const data = await res.json();

  allResults = data;
  lastResults = data;
  currentPage = 1;

  localStorage.setItem('search_results', JSON.stringify(data));
  localStorage.setItem('current_page', currentPage);

  renderTable();
  startDialog(data);
}

/* ================= TABLE ================= */
function renderTable() {
  const tbody = $('#results');
  tbody.empty();

  if (!allResults.length) {
    tbody.append(`<tr><td colspan="7" class="text-center">Ничего не найдено</td></tr>`);
    return;
  }

  const start = (currentPage - 1) * pageSize;
  const pageItems = allResults.slice(start, start + pageSize);

  pageItems.forEach((r, i) => {
    tbody.append(`
      <tr>
        <td>${start + i + 1}</td>
        <td>${r.institution}</td>
        <td>${r.region}</td>
        <td>${r.specialty}</td>
        <td>${r.language}</td>
        <td>${r.price === null ? 'Бюджет' : r.price}</td>
        <td>${r.plan_count}</td>
      </tr>
    `);
  });
}

/* ================= AI ================= */
function startDialog(results) {
  lastResults = results;
  $('#ai-dialog-card').show();

  callDialog({
    session_id: SESSION_ID,
    results: lastResults
  });
}

async function callDialog(payload) {
  const res = await fetch(AI_API, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  if (data.type === 'question') renderQuestion(data);
  if (data.type === 'final') renderFinal(data.text);
}

function renderQuestion(data) {
  $('#ai-messages').append(`<div><b>ИИ:</b> ${data.text}</div>`);
  const opt = $('#ai-options').html('');

  data.options.forEach(o => {
    opt.append(`<button onclick="answerDialog('${data.key}','${o.value}')">${o.label}</button>`);
  });

  saveChat();
}

function answerDialog(key, value) {
  $('#ai-messages').append(`<div class="text-right"><b>Вы:</b> ${value}</div>`);
  $('#ai-options').html('');

  callDialog({
    session_id: SESSION_ID,
    answer: { [key]: value },
    results: lastResults
  });

  saveChat();
}

function renderFinal(text) {
  $('#ai-messages').append(`<div><b>ИИ:</b><br>${text.replace(/\n/g,'<br>')}</div>`);
  saveChat();
}

function resetDialog() {
  localStorage.removeItem('ai_chat_html');
  $('#ai-messages').html('');
  $('#ai-options').html('');

  callDialog({
    session_id: SESSION_ID,
    reset: true
  });
}

/* ================= PERSIST ================= */
function saveFilters() {
  localStorage.setItem('search_filters', JSON.stringify({
    language: $('#language').val(),
    specialty: $('#specialty').val(),
    region_id: $('#region_id').val(),
    district_id: $('#district_id').val(),
    locality_id: $('#locality_id').val(),
    budget: $('#budget').val()
  }));
}

function restoreFilters() {
  const f = JSON.parse(localStorage.getItem('search_filters') || 'null');
  if (!f) return;

  $('#language').val(f.language);
  $('#specialty').val(f.specialty);
  $('#budget').val(f.budget);

  if (f.region_id) {
    $('#region_id').val(f.region_id).trigger('change');
    setTimeout(() => {
      $('#district_id').val(f.district_id).trigger('change');
      setTimeout(() => $('#locality_id').val(f.locality_id), 300);
    }, 300);
  }
}

function restoreResults() {
  const saved = localStorage.getItem('search_results');
  if (!saved) return;

  allResults = JSON.parse(saved);
  currentPage = Number(localStorage.getItem('current_page')) || 1;
  renderTable();
  startDialog(allResults);
}

function saveChat() {
  localStorage.setItem('ai_chat_html', $('#ai-messages').html());
}

function restoreChat() {
  const chat = localStorage.getItem('ai_chat_html');
  if (chat) {
    $('#ai-messages').html(chat);
    $('#ai-dialog-card').show();
  }
}
</script>


</body>
</html>
